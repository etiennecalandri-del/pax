<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PAX ‚Äî Tableau de bord Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --navy:       #0A1628;
      --navy-mid:   #1B3A6B;
      --gold:       #C9A84C;
      --gold-light: #F0D078;
      --white:      #FFFFFF;
      --off-white:  #F8FAFC;
      --gray-100:   #E2E8F0;
      --gray-200:   #CBD5E1;
      --gray-400:   #94A3B8;
      --gray-500:   #64748B;
      --gray-700:   #334155;
      --gray-900:   #0F172A;
      --green:      #16A34A;
      --amber:      #D97706;
      --red:        #DC2626;
      --radius:     12px;
      --shadow:     0 4px 16px rgba(10,22,40,.1);
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
      background: var(--off-white); color: var(--gray-900);
      -webkit-font-smoothing: antialiased;
    }
    header {
      background: var(--navy); padding: 0 28px; height: 64px;
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 50;
      box-shadow: 0 2px 12px rgba(10,22,40,.25);
    }
    .logo { font-size: 1.1rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 10px; }
    .logo span { color: var(--gold-light); }
    header a { color: rgba(255,255,255,.6); font-size: .85rem; text-decoration: none; }
    header a:hover { color: var(--white); }
    main { max-width: 1200px; margin: 0 auto; padding: 32px 24px 64px; }
    h1 { font-size: 1.6rem; font-weight: 800; color: var(--navy); margin-bottom: 4px; }
    .subtitle { color: var(--gray-400); font-size: .9rem; margin-bottom: 32px; }
    .refresh-btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--navy); color: var(--white); font-weight: 600;
      font-size: .85rem; padding: 8px 18px; border-radius: 8px;
      border: none; cursor: pointer; transition: opacity .2s;
      margin-bottom: 32px;
    }
    .refresh-btn:hover { opacity: .85; }

    /* Stat Cards */
    .stat-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px; margin-bottom: 32px;
    }
    .stat-card {
      background: var(--white); border-radius: var(--radius);
      padding: 24px; box-shadow: var(--shadow);
      border-top: 3px solid var(--navy);
    }
    .stat-card.gold  { border-top-color: var(--gold); }
    .stat-card.green { border-top-color: var(--green); }
    .stat-card.amber { border-top-color: var(--amber); }
    .stat-label { font-size: .78rem; font-weight: 600; color: var(--gray-400); text-transform: uppercase; letter-spacing: .06em; margin-bottom: 8px; }
    .stat-value { font-size: 2.2rem; font-weight: 900; color: var(--navy); letter-spacing: -.04em; }
    .stat-card.gold  .stat-value { color: var(--amber); }
    .stat-card.green .stat-value { color: var(--green); }
    .stat-sub { font-size: .82rem; color: var(--gray-400); margin-top: 4px; }

    /* Charts Grid */
    .charts-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 20px; margin-bottom: 32px;
    }
    .chart-card {
      background: var(--white); border-radius: var(--radius);
      padding: 24px; box-shadow: var(--shadow);
    }
    .chart-card.wide { grid-column: 1 / -1; }
    .chart-title { font-size: 1rem; font-weight: 700; color: var(--navy); margin-bottom: 20px; }
    .chart-wrap { position: relative; height: 240px; }
    .chart-wrap.tall { height: 300px; }

    /* Table */
    .table-card {
      background: var(--white); border-radius: var(--radius);
      padding: 24px; box-shadow: var(--shadow);
    }
    .table-title { font-size: 1rem; font-weight: 700; color: var(--navy); margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: .85rem; }
    th {
      text-align: left; padding: 10px 12px;
      font-size: .75rem; font-weight: 700; color: var(--gray-400);
      text-transform: uppercase; letter-spacing: .04em;
      border-bottom: 2px solid var(--gray-100);
    }
    td { padding: 10px 12px; border-bottom: 1px solid var(--gray-100); color: var(--gray-700); }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--off-white); }
    .badge-elig   { background: #D1FAE5; color: var(--green); padding: 3px 10px; border-radius: 50px; font-weight: 700; font-size: .75rem; }
    .badge-noelig { background: #FEE2E2; color: var(--red);   padding: 3px 10px; border-radius: 50px; font-weight: 700; font-size: .75rem; }

    /* Empty state */
    .empty { text-align: center; padding: 60px 24px; color: var(--gray-400); }
    .empty .empty-icon { font-size: 3rem; margin-bottom: 16px; }
    .empty h3 { font-size: 1.1rem; font-weight: 700; color: var(--gray-500); margin-bottom: 8px; }

    /* Loader */
    .loader-wrap { display: flex; justify-content: center; padding: 60px; }
    .spinner {
      width: 36px; height: 36px; border-radius: 50%;
      border: 3px solid var(--gray-100); border-top-color: var(--navy);
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .charts-grid { grid-template-columns: 1fr; }
      .chart-card.wide { grid-column: auto; }
      .stat-grid { grid-template-columns: 1fr 1fr; }
      table { display: block; overflow-x: auto; }
    }
    @media (max-width: 480px) {
      .stat-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">‚úà PAX ‚Äî Admin</div>
  <a href="/">‚Üê Retour au simulateur</a>
</header>

<main>
  <h1>Tableau de bord</h1>
  <p class="subtitle" id="lastUpdated">Chargement‚Ä¶</p>
  <button class="refresh-btn" onclick="loadStats()">‚Üª Actualiser</button>

  <div id="content">
    <div class="loader-wrap"><div class="spinner"></div></div>
  </div>
</main>

<script>
async function loadStats() {
  document.getElementById('lastUpdated').textContent = 'Mise √† jour en cours‚Ä¶';
  try {
    const res = await fetch('/api/admin/stats');
    if (!res.ok) throw new Error('API error');
    const data = await res.json();
    renderDashboard(data);
    document.getElementById('lastUpdated').textContent =
      'Derni√®re mise √† jour : ' + new Date().toLocaleString('fr-FR');
  } catch (err) {
    document.getElementById('content').innerHTML =
      `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><h3>Erreur de chargement</h3><p>${err.message}</p></div>`;
    document.getElementById('lastUpdated').textContent = 'Erreur';
  }
}

function renderDashboard(d) {
  // Destroy existing charts
  Chart.helpers.each(Chart.instances, c => c.destroy());

  const incidentLabels = {
    delay: 'Retard', cancellation: 'Annulation', denied_boarding: 'Refus embarquement'
  };
  const countryLabels = {
    FR:'France', DE:'Allemagne', ES:'Espagne', IT:'Italie', NL:'Pays-Bas',
    BE:'Belgique', PT:'Portugal', GR:'Gr√®ce', AT:'Autriche', PL:'Pologne',
    SE:'Su√®de', DK:'Danemark', FI:'Finlande', IE:'Irlande', GB:'Royaume-Uni',
    CH:'Suisse', OTHER:'Autre'
  };

  const html = `
    <!-- KPI Cards -->
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-label">Simulations totales</div>
        <div class="stat-value">${d.total.toLocaleString('fr-FR')}</div>
        <div class="stat-sub">depuis le lancement</div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">Cas √©ligibles</div>
        <div class="stat-value">${d.eligible.toLocaleString('fr-FR')}</div>
        <div class="stat-sub">${d.eligibilityRate}&nbsp;% d'√©ligibilit√©</div>
      </div>
      <div class="stat-card gold">
        <div class="stat-label">Montant moyen r√©clam√©</div>
        <div class="stat-value">${d.avgAmount}&nbsp;‚Ç¨</div>
        <div class="stat-sub">sur dossiers √©ligibles</div>
      </div>
      <div class="stat-card amber">
        <div class="stat-label">Taux d'√©ligibilit√©</div>
        <div class="stat-value">${d.eligibilityRate}&nbsp;%</div>
        <div class="stat-sub">des simulations</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card wide">
        <div class="chart-title">üìà Simulations par jour (30 derniers jours)</div>
        <div class="chart-wrap tall"><canvas id="chartTimeline"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">‚úà Top 5 compagnies r√©clam√©es</div>
        <div class="chart-wrap"><canvas id="chartAirlines"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üî∂ R√©partition par type d'incident</div>
        <div class="chart-wrap"><canvas id="chartIncidents"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üåç R√©partition par pays de d√©part</div>
        <div class="chart-wrap"><canvas id="chartCountries"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">‚úÖ √âligible vs Non √©ligible</div>
        <div class="chart-wrap"><canvas id="chartEligibility"></canvas></div>
      </div>
    </div>

    <!-- Recent Simulations Table -->
    <div class="table-card">
      <div class="table-title">üïê 20 derni√®res simulations (donn√©es anonymes)</div>
      ${renderTable(d.recent, incidentLabels, countryLabels)}
    </div>
  `;

  document.getElementById('content').innerHTML = html;

  const NAVY   = '#0A1628';
  const GOLD   = '#C9A84C';
  const GREEN  = '#16A34A';
  const RED    = '#DC2626';
  const AMBER  = '#D97706';
  const COLORS = [NAVY, '#2563EB', GOLD, GREEN, '#7C3AED', '#DB2777', AMBER, '#0891B2'];

  const defaultFont = { family: 'Inter, sans-serif', size: 12 };
  Chart.defaults.font = defaultFont;
  Chart.defaults.color = '#64748B';

  // Timeline
  if (d.byDay && d.byDay.length) {
    new Chart(document.getElementById('chartTimeline'), {
      type: 'line',
      data: {
        labels: d.byDay.map(r => r.date),
        datasets: [{
          label: 'Simulations',
          data: d.byDay.map(r => r.count),
          borderColor: GOLD,
          backgroundColor: 'rgba(201,168,76,.12)',
          fill: true,
          tension: .4,
          pointBackgroundColor: GOLD,
          pointRadius: 4,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: '#F1F5F9' } },
          x: { grid: { display: false } }
        }
      }
    });
  }

  // Airlines Bar
  if (d.topAirlines && d.topAirlines.length) {
    new Chart(document.getElementById('chartAirlines'), {
      type: 'bar',
      data: {
        labels: d.topAirlines.map(r => r.airline),
        datasets: [{
          label: 'Simulations',
          data: d.topAirlines.map(r => r.count),
          backgroundColor: COLORS.slice(0, d.topAirlines.length),
          borderRadius: 6,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true, grid: { color: '#F1F5F9' } }, y: { grid: { display: false } } }
      }
    });
  }

  // Incidents Doughnut
  if (d.byIncident && d.byIncident.length) {
    new Chart(document.getElementById('chartIncidents'), {
      type: 'doughnut',
      data: {
        labels: d.byIncident.map(r => incidentLabels[r.incident_type] || r.incident_type),
        datasets: [{
          data: d.byIncident.map(r => r.count),
          backgroundColor: [NAVY, GOLD, GREEN, AMBER],
          borderWidth: 0,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        cutout: '60%',
        plugins: { legend: { position: 'bottom', labels: { padding: 12, boxWidth: 12 } } }
      }
    });
  }

  // Countries Bar
  if (d.byCountry && d.byCountry.length) {
    new Chart(document.getElementById('chartCountries'), {
      type: 'bar',
      data: {
        labels: d.byCountry.map(r => countryLabels[r.departure_country] || r.departure_country),
        datasets: [{
          label: 'Simulations',
          data: d.byCountry.map(r => r.count),
          backgroundColor: '#2563EB',
          borderRadius: 4,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true, grid: { color: '#F1F5F9' } }, y: { grid: { display: false } } }
      }
    });
  }

  // Eligibility Pie
  new Chart(document.getElementById('chartEligibility'), {
    type: 'pie',
    data: {
      labels: ['√âligibles', 'Non √©ligibles'],
      datasets: [{
        data: [d.eligible, d.total - d.eligible],
        backgroundColor: [GREEN, RED],
        borderWidth: 0,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom', labels: { padding: 12, boxWidth: 12 } } }
    }
  });
}

function renderTable(rows, incidentLabels, countryLabels) {
  if (!rows || !rows.length) {
    return `<div class="empty"><div class="empty-icon">üìä</div><h3>Aucune donn√©e disponible</h3><p>Lancez des simulations pour voir les statistiques.</p></div>`;
  }
  const formatDate = d => new Date(d).toLocaleDateString('fr-FR');
  const rows_html = rows.map(r => `
    <tr>
      <td>${formatDate(r.created_at)}</td>
      <td>${escHtml(r.airline)}</td>
      <td>${escHtml(r.departure_airport)} ‚Üí ${escHtml(r.arrival_airport)}</td>
      <td>${incidentLabels[r.incident_type] || r.incident_type}</td>
      <td>${countryLabels[r.departure_country] || r.departure_country}</td>
      <td><span class="${r.eligible ? 'badge-elig' : 'badge-noelig'}">${r.eligible ? '√âligible' : 'Non √©ligible'}</span></td>
      <td>${r.eligible ? r.compensation_amount + ' ‚Ç¨' : '‚Äî'}</td>
    </tr>
  `).join('');
  return `
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Compagnie</th><th>Trajet</th>
          <th>Incident</th><th>Pays</th><th>R√©sultat</th><th>Montant</th>
        </tr>
      </thead>
      <tbody>${rows_html}</tbody>
    </table>`;
}

function escHtml(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Load on page ready
loadStats();
</script>
</body>
</html>
